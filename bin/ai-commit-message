#!/bin/sh -e

function usage {
  echo "Usage: ai-commit-message [-L | --lang <lang>]"
  echo "Options:"
  echo "  -L,--lang Language for output (default: en)"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -L|--lang)
      PROMPT_LANG=$2
      shift 2
      ;;
    -K|--keyword)
      PROMPT_KEYWORD=$2
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      shift 1
      ;;
    *)
      echo "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done
if [ -z "$PROMPT_LANG" ]; then
  PROMPT_LANG="en"
fi

# get diff
DIFF=$(git diff --staged)
if [ -z "$DIFF" ]; then
  echo "No changes to commit. git add some changes and try again."
  exit 1
fi

# prompt for ai
PROMPT=$(cat <<EOL
generate git commit message from below diff, in one sentence.
must follow format: <type>: <subject>
subject should include purpose as much as possible.
type const: feat, fix, docs, style, refactor, test, chore
output language: ${PROMPT_LANG}
--
${DIFF}
--
EOL
)

# generate commit message
RAW_MESSAGE=$(echo "$PROMPT" | chatgpt-cli -n 2>/dev/null)

# remove quotes
echo "$RAW_MESSAGE" | tr -d "'\""
