#!/bin/sh -e

while [[ $# -gt 0 ]]; do
  case "$1" in
    -jp|--japanese)
      PROMPT_LANG="jp"
      shift 1
      ;;
    *)
      echo "Invalid option: $1"
      exit 1
      ;;
  esac
done

# get diff
DIFF=$(git diff --staged)
if [ -z "$DIFF" ]; then
  echo "No changes to commit"
  exit 1
fi

# prompt for ai
if [ "$PROMPT_LANG" = "jp" ]; then
  PROMPT=$(cat <<EOL
以下の差分から、一行でコミットメッセージを生成してください。
フォーマットは <type>: <subject> です。
できるだけ目的を含めてください。
subjectは日本語で書いてください。
--
${DIFF}
--
EOL
  )

else
  PROMPT=$(cat <<EOL
generate git commit message from below diff, in one sentence.
must follow format: <type>: <subject>
include purpose as much as possible.
--
${DIFF}
--
EOL
  )
fi

# generate commit message
RAW_MESSAGE=$(echo "$PROMPT" | chatgpt-cli -n 2>/dev/null)

# remove quotes
# and prefer to change Refactor to Modify
echo "$RAW_MESSAGE" | tr -d "'\"" | sed -e 's/^Refactored/Modified/i' -e 's/^Refactor/Modify/i'
